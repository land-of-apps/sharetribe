# Turn on validation, so we can use import:
version: ~> 1.0

rvm:
- 2.6.5

services:
- mysql

import:
- land-of-apps/land-of-apps:travis/ruby-imports.yml

jobs:
  include:
  - stage: rspec_admin
    workspaces:
      create:
        name: assets
        paths:
        - vendor/bundle
        - public/assets
        - public/packs-test
        - node_modules
        - app/javascript/packages/*/node_modules
    install:
    - bundle config path vendor/bundle
    - bundle install --jobs 3 --retry 3
    - bundle update appmap
    - nvm install 10.15
    - npm install
    - sudo apt-get install sphinxsearch
    script:
    - cp config/database.example.yml config/database.yml
    - cp config/config.example.yml config/config.yml
    - bundle exec rails assets:precompile
    - bundle exec rake db:create db:structure:load
    - bundle exec rake ts:index
    - bundle exec rake ts:start
    - APPMAP=true bundle exec rspec || true
    - APPMAP=true bundle exec cucumber features/admin || true

    # remove problematic appmaps until patch
    # - cd /home/travis/build/land-of-apps/sharetribe/tmp/appmap/rspec
    # - rm PeopleController_show_shows_specific_meta_title_and_description.appmap.json
    # - rm PeopleController_show_works.appmap.json
    # - cd ../../..
    #
    after_script:
    - true
  - stage: admin_2
    workspaces:
      use:
      - assets
    before_script:
    - nvm install 10.15
    - npm install
    - sudo apt-get install sphinxsearch
    script:
    - cp config/database.example.yml config/database.yml
    - cp config/config.example.yml config/config.yml
    - bundle exec rails assets:precompile
    - bundle exec rake db:create db:structure:load
    - bundle exec rake ts:index
    - bundle exec rake ts:start
    - APPMAP=true bundle exec cucumber features/admin2 features/common features/communities features/conversations features/email features/feedback features/homepage features/infos features/invitations || true
    after_script:
    - true
  - stage: rest_of_cucumber
    workspaces:
      use:
      - assets
    before_script:
    - nvm install 10.15
    - npm install
    - sudo apt-get install sphinxsearch
    script:
    - cp config/database.example.yml config/database.yml
    - cp config/config.example.yml config/config.yml
    - bundle exec rails assets:precompile
    - bundle exec rake db:create db:structure:load
    - bundle exec rake ts:index
    - bundle exec rake ts:start
    - APPMAP=true bundle exec cucumber features/listings features/payments features/paypal features/people features/sessions features/settings features/step_definitions features/stripe features/support || true
    after_script:
    - true
  - stage: upload
    workspaces:
      use:
      - appmaps
    install:
    - true
    script:
    - true
